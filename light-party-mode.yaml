blueprint:
  name: Light Party Mode
  description: 'Create a party effect with your lights by cycling through bright saturated colors.
    
    Version: 0.0.2
    
    Features:
    - Select which lights to control
    - Configurable color transition time
    - Adjustable brightness levels
    - Return to previous state or scene when turned off
    - Controlled by an input_boolean switch'
  domain: automation
  input:
    trigger_boolean:
      name: Control Switch
      description: The input_boolean that controls the party mode
      selector:
        entity:
          filter:
            - domain: input_boolean
            - domain: switch
    lights:
      name: Lights
      description: Select the lights you want to control
      selector:
        entity:
          domain: light
          multiple: true
    transition_time:
      name: Color Transition Time
      description: Time in seconds between color changes (1-300)
      default: 5
      selector:
        number:
          min: 1
          max: 300
          unit_of_measurement: seconds
          mode: slider
          step: 1
    min_brightness:
      name: Minimum Brightness
      description: Minimum brightness level (1-100)
      default: 50
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: '%'
          mode: slider
          step: 1
    max_brightness:
      name: Maximum Brightness
      description: Maximum brightness level (1-100)
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: '%'
          mode: slider
          step: 1
    fixed_brightness:
      name: Fixed Brightness
      description: Set a fixed brightness level (0 to disable fixed brightness)
      default: 0
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
          mode: slider
          step: 1
    return_scene:
      name: Return Scene(s)
      description: Optional - Scene(s) to activate when party mode is turned off (leave empty to return to previous state)
      default: null
      selector:
        entity:
          domain: scene
          multiple: true

variables:
  fixed_brightness: !input fixed_brightness
  min_brightness: !input min_brightness
  max_brightness: !input max_brightness
  target_lights: !input lights
  disco_colors:
    - [255, 0, 0]     # Red
    - [255, 0, 255]   # Magenta
    - [0, 0, 255]     # Blue
    - [0, 255, 255]   # Cyan
    - [0, 255, 0]     # Green
    - [255, 255, 0]   # Yellow

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input trigger_boolean
    to: "on"

action:
  # Store initial state
  - service: scene.create
    data:
      scene_id: before_party
      snapshot_entities: "{{ target_lights }}"

  # Main party sequence
  - repeat:
      sequence:
        - service: light.turn_on
          target:
            entity_id: "{{ target_lights }}"
          data:
            rgb_color: "{{ disco_colors[repeat.index-1] }}"
            brightness_pct: >
              {% if fixed_brightness > 0 %}
                {{ fixed_brightness }}
              {% else %}
                {{ range(min_brightness|int, max_brightness|int)|random }}
              {% endif %}
            transition: "{{ transition_time|int / 2 }}"
        - delay:
            seconds: "{{ transition_time }}"
      until:
        - condition: state
          entity_id: !input trigger_boolean
          state: "off"

  # Return to previous state or scene
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ return_scene != None }}"
        sequence:
          - repeat:
              count: "{{ return_scene | length }}"
              sequence:
                - service: scene.turn_on
                  target:
                    entity_id: "{{ return_scene[repeat.index - 1] }}"
                  data:
                    transition: 2
      default:
        - service: scene.turn_on
          target:
            entity_id: scene.before_party